angular.module("ez.table",[]).constant("EzTableConfig",{limit:10,limits:[5,10,25,100],sortField:null,sortAscending:!1,globalSearchField:null,showBatchActions:!1}).directive("ezTable",["$filter","$timeout","EzTableConfig",function(a,b,c){return{restrict:"A",scope:!0,compile:function(d){var e,f,g,h="<thead><tr>",i='<tr ng-show="showFilters"><th></th>',j=d.find("tbody tr:first-child td");h+='<th><input class="batch-checkbox" type="checkbox" ng-model="isToggled" ng-change="toggleAll()" ng-show="showBatchActions" /></th>';for(var k=1;k<j.length-1;k++){if(e=angular.element(j[k]).data("title"),!e)throw new Error('data-title attribute must be specified for column "'+k+'"');f=e.charAt(0).toLowerCase()+e.slice(1),g=angular.element(j[k]).data("field")||f,h+="<th class=\"sorting\" ng-class=\"{'sorting_asc': !sortAscending && sortField == '"+g+"', 'sorting_desc': sortAscending && sortField == '"+g+"'} \" ><a ng-click=\"sort('"+g+"')\">"+e+"<span ng-show=\"sortField == '"+f+"'\" ></span></a></th>",i+='<th><input class="form-control" ng-model="filters.'+g+'" type="text" ng-change="filter(\''+g+"')\"/></th>"}h+="<th></th></tr>",i+="<th></th></tr>",h+=i+"</thead>",d.prepend(h);var l='<tfoot><tr>                     <tr>                      <td colspan="100%">                         <div class="row" >                             <div class="limit-selector col-md-6">                                 <a ng-click="pager.setRowsPerPage(10)" ng-class="{active: limit == 10}" >10</a><span>|</span>                                 <a ng-click="pager.setRowsPerPage(25)" ng-class="{active: limit == 25}" >25</a><span>|</span>                                 <a ng-click="pager.setRowsPerPage(50)" ng-class="{active: limit == 50}" >50</a>                             </div>                             <div class="col-md-6 dataTables_paginate paging_bootstrap">                                 <div class="dataTables_paginate paging_bootstrap">                                     <!-- pagination -->                                     <ul class="pagination pagination-sm" ng-show="pager.totalPages > 0" >                                         <li ng-class="{disabled: pager.currentPage == 1}">                                             <a ng-click="prev()" ><i class="fa fa-chevron-left"></i></a>                                         </li>                                         <li ng-repeat="page in pager.pages" class="" ng-class="{active: pager.currentPage === page, inactive: pager.currentPage !== page}">                                             <a ng-click="setPage(page -1)">                                                 {{page }}                                             </a>                                         </li>                                         <li ng-class="{disabled: pager.currentPage == pager.totalPages}">                                             <a ng-click="next()" ><i class="fa fa-chevron-right"></i></a>                                         </li>                                     </ul>                                </div>                             </div>                         </div>                         <a class="filter-toggle btn btn-sm btn-default" ng-click="showFilters = !showFilters" title="Toggle Filters"><i class="icon-search"></i><span>Search</span></a>                     </td>                      </tr>                 </tfoot>';return d.append(l),d.addClass("table ez-table table-striped table-hover table-full-width dataTable table-condensed"),function(d,e,f){d.limit=parseInt(f.limit,10)||c.limit,d.limits=d.$eval(f.limits)||c.limits,d.sortField=d.$eval(f.sortField)||c.sortField,d.sortAscending=d.$eval(f.sortAscending)||c.sortAscending,d.showBatchActions=d.$eval(f.showBatchActions)||c.showBatchActions;var g=d.$eval(f.searchField)||c.globalSearchField;d.pager={},d.pager.currentPage=1,d.pager.maxPages=7,d.pager.rowsPerPage=d.limit,d.pager.setPage=function(a){if(console.log(a),a&&(d.pager.currentPage=parseInt(a)),d.pager.maxPages<d.pager.totalPages){var b=Math.max(d.pager.currentPage-Math.floor(d.pager.maxPages/2),1),c=b+d.pager.maxPages-1;for(c>d.pager.totalPages&&(c=d.pager.totalPages,b=c-d.pager.maxPages+1),d.pager.pages=[],b;c>=b;b++)d.pager.pages.push(b)}},d.pager.next=function(){return d.pager.currentPage<d.pager.totalPages&&d.pager.setPage(++d.pager.currentPage),d.pager.currentPage},d.pager.prev=function(){return d.pager.currentPage>1&&d.pager.setPage(--d.pager.currentPage),d.pager.currentPage},d.pager.refresh=function(a){d.pager.totalRows=a.length,d.pager.totalPages=Math.ceil(a.length/d.pager.rowsPerPage);var b=parseInt(1),c=d.pager.totalPages<d.pager.maxPages?d.pager.totalPages:d.pager.maxPages;for(d.pager.pages=[],b;c>=b;b++)d.pager.pages.push(b)},d.pager.setRowsPerPage=function(a){d.limit=a,d.setPage(0)},d.currentPage=0,d.batchAction="",d.filters={},d.setPage=function(a){d.currentPage=a,d.items=d.pages[a],d.pager.setPage(a+1)},d.calcPages=function(b){var c=[];for(var e in d.filters)break;c=d.sortField?a("orderBy")(d.$eval(f.ezTable),d.sortField,!d.sortAscending):d.$eval(f.ezTable),e&&(c=a("filter")(c,d.filters)),g&&(c=a("filter")(c,{$:g})),d.pageCount=c.length/d.limit,d.pages=[];for(var h=0;h<d.pageCount;h++)d.pages[h]=c.slice(h*d.limit,h*d.limit+d.limit);d.pager.refresh(c),d.setPage(b)},d.toggleAll=function(){angular.forEach(d.items,function(a,b){d.items[b]._selected=d.isToggled})},d.prev=function(){d.items=d.pages[d.pager.prev()-1],d.isToggled=!1},d.next=function(){d.items=d.pages[d.pager.next()-1],d.isToggled=!1},d.sort=function(a){d.sortAscending=!d.sortAscending,d.sortField=a,d.calcPages(d.currentPage)},d.filter=function(){d.calcPages(0)},d.$watch("limit",function(a,b){a!==b&&d.calcPages(0)}),d.$watch(f.ezTable,function(a){if(d.showBatchActions=!1,a){var b=a.length;angular.forEach(a,function(a,c){return a._selected?void(d.showBatchActions=!0):void(c+1===b&&(d.isToggled=!1))}),d.calcPages(d.pager.currentPage-1)}},!0),d.$watch("searchString",function(a,c){a!==c&&b(function(){g=a,d.filter()},300)})}}}}]);